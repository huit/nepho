{#
    Load Balancer for web traffic on 80 and 443.
    
    Assumes:
    
    1) that the VPC is named "VPC," 
    2) a public network in the VPC named "PublicSubnet",
    3) a private network tier "PrivateSubnet",
    4) a Launch Config named "LaunchConfig"
    5) typical set of instance parameters, in partiular value "InstanceCount"
    
#}

    {%- macro load_balancer(name, subnet='', inports=80, outports=80 ) -%}
    
    "{{ name }}ElasticLoadBalancer" : {
      "Type" : "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties" : {
        "SecurityGroups" : [ { "Ref" : "{{ name }}LoadBalancerSecurityGroup" } ],
        {% if subnet is defined  %}"Subnets" : [ { "Ref" : "{{ subnet }}" } ],{% endif %}
        "Listeners" : [ { "LoadBalancerPort" : "80",  "InstancePort" : "80",  "Protocol" : "HTTP" }  ],
        "HealthCheck" : {
          "Target" : "HTTP:80/",
          "HealthyThreshold" : "3",
          "UnhealthyThreshold" : "5",
          "Interval" : "90",
          "Timeout" : "60"
        }
      }
    },

    "{{ name }}LoadBalancerSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "{{ name }} ELB Security Group with HTTP access on port 80 from the internet",
        {% if subnet is defined  %}"VpcId" : { "Ref" : "VPC" },{% endif %}
        "SecurityGroupIngress" : [ 
          {% for p in inports %}
             {"IpProtocol" : "tcp", "FromPort" : "{{ p }}",  "ToPort" :  "{{ p }}", "CidrIp" : "0.0.0.0/0"}
             {% if not p == last(inports) %},{% endif %}
          {% endfor %}
            
         ],
        "SecurityGroupEgress" : [ 
          {% for p in outports %}
             {"IpProtocol" : "tcp", "FromPort" : "{{ p }}",  "ToPort" :  "{{ p }}", "CidrIp" : "0.0.0.0/0"}
             {% if not p == last(inports) %},{% endif %}
          {% endfor %}
            
         ]         
      }
    }